<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#0f172a">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="manifest" href="manifest.json">
<title>–ù–∞–ø–æ–º–Ω–∏</title>
<style>
:root {
  --bg: #0f172a; --card: #1e293b; --border: #334155;
  --primary: #38bdf8; --accent: #f472b6; --success: #34d399;
  --warn: #fbbf24; --danger: #f87171;
  --text: #f1f5f9; --muted: #94a3b8;
}
* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
html, body { height: 100%; }
body {
  background: var(--bg); color: var(--text);
  font-family: 'Segoe UI', system-ui, sans-serif;
  max-width: 480px; margin: 0 auto;
  display: flex; flex-direction: column; min-height: 100vh;
  overflow-x: hidden;
}

/* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 14px 16px 10px;
  background: var(--bg);
  position: sticky; top: 0; z-index: 50;
  border-bottom: 1px solid var(--border);
}
.app-title { font-size: 1.1rem; font-weight: 800; color: var(--primary); }
.header-btns { display: flex; gap: 8px; }
.icon-btn {
  background: var(--card); border: 1px solid var(--border);
  color: var(--muted); border-radius: 8px; padding: 6px 10px;
  cursor: pointer; font-size: .85rem;
}

/* ‚îÄ‚îÄ Calendar ‚îÄ‚îÄ */
.cal-section { padding: 12px 12px 0; }
.cal-nav {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 10px;
}
.cal-month { font-size: 1rem; font-weight: 700; color: var(--text); }
.cal-arrow {
  background: var(--card); border: 1px solid var(--border);
  color: var(--muted); border-radius: 8px; padding: 4px 12px;
  cursor: pointer; font-size: 1rem;
}
.cal-grid {
  display: grid; grid-template-columns: repeat(7, 1fr);
  gap: 2px;
}
.cal-dow {
  text-align: center; font-size: .7rem; color: var(--muted);
  padding: 2px 0 6px; font-weight: 600;
}
.cal-day {
  display: flex; flex-direction: column; align-items: center;
  padding: 5px 2px; border-radius: 8px; cursor: pointer;
  transition: background .15s; min-height: 44px; justify-content: center;
  position: relative;
}
.cal-day:active { background: var(--border); }
.cal-day.other-month .day-num { color: #3b4f6a; }
.cal-day.today .day-num {
  background: var(--primary); color: #0f172a;
  border-radius: 50%; width: 28px; height: 28px;
  display: flex; align-items: center; justify-content: center;
  font-weight: 800;
}
.cal-day.selected { background: #1e3a5f; }
.cal-day.selected .day-num { color: var(--primary); font-weight: 700; }
.day-num { font-size: .9rem; line-height: 1; }
.day-dots { display: flex; gap: 2px; margin-top: 3px; flex-wrap: wrap; justify-content: center; }
.day-dot { width: 5px; height: 5px; border-radius: 50%; }

/* ‚îÄ‚îÄ Day panel ‚îÄ‚îÄ */
.day-panel {
  margin: 10px 12px 0;
  background: var(--card); border: 1px solid var(--border);
  border-radius: 12px; overflow: hidden;
}
.day-panel-title {
  padding: 10px 14px 6px;
  font-size: .85rem; font-weight: 700; color: var(--muted);
}
.task-item {
  display: flex; align-items: flex-start; gap: 10px;
  padding: 10px 14px; border-top: 1px solid var(--border);
  transition: background .15s;
}
.task-item:first-of-type { border-top: none; }
.task-dot {
  width: 10px; height: 10px; border-radius: 50%;
  flex-shrink: 0; margin-top: 5px;
}
.task-info { flex: 1; min-width: 0; }
.task-text { font-size: .95rem; font-weight: 600; color: var(--text); }
.task-times { font-size: .78rem; color: var(--muted); margin-top: 2px; }
.task-del {
  background: none; border: none; color: #475569;
  cursor: pointer; font-size: 1.1rem; padding: 0 2px;
  flex-shrink: 0;
}
.task-del:active { color: var(--danger); }
.task-item.past .task-text { color: var(--muted); text-decoration: line-through; }
.empty-day {
  padding: 16px 14px; color: var(--muted); font-size: .88rem; text-align: center;
}

/* ‚îÄ‚îÄ Upcoming strip ‚îÄ‚îÄ */
.upcoming-section { padding: 10px 12px 120px; }
.section-title { font-size: .8rem; font-weight: 700; color: var(--muted); margin-bottom: 8px; text-transform: uppercase; letter-spacing: .05em; }

/* ‚îÄ‚îÄ Mic button (FAB) ‚îÄ‚îÄ */
.fab-wrap {
  position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%);
  z-index: 100; display: flex; flex-direction: column; align-items: center; gap: 6px;
}
.mic-btn {
  width: 68px; height: 68px; border-radius: 50%;
  background: linear-gradient(135deg, #e879f9, #f472b6);
  border: none; cursor: pointer;
  box-shadow: 0 4px 24px rgba(244,114,182,.5);
  font-size: 1.8rem;
  display: flex; align-items: center; justify-content: center;
  transition: transform .15s, box-shadow .15s;
}
.mic-btn:active { transform: scale(.92); }
.mic-btn.listening {
  animation: micPulse 1s ease-in-out infinite;
  background: linear-gradient(135deg, #f87171, #e879f9);
}
@keyframes micPulse {
  0%,100% { box-shadow: 0 4px 24px rgba(244,114,182,.5); }
  50%      { box-shadow: 0 4px 40px rgba(244,114,182,.9), 0 0 0 12px rgba(244,114,182,.15); }
}
.mic-hint { font-size: .75rem; color: var(--muted); text-align: center; }
.transcript-bubble {
  background: var(--card); border: 1px solid var(--border);
  border-radius: 12px; padding: 8px 14px;
  font-size: .85rem; color: var(--text); max-width: 280px;
  text-align: center; min-height: 36px;
  display: none;
}
.transcript-bubble.show { display: block; }

/* ‚îÄ‚îÄ Preview modal ‚îÄ‚îÄ */
.modal-backdrop {
  position: fixed; inset: 0; background: rgba(0,0,0,.7);
  z-index: 200; display: none; align-items: flex-end;
}
.modal-backdrop.show { display: flex; }
.modal-sheet {
  background: var(--card); border-radius: 20px 20px 0 0;
  padding: 20px 16px 32px; width: 100%;
  animation: slideUp .25s ease;
}
@keyframes slideUp { from { transform: translateY(60px); opacity: 0; } }
.modal-title { font-size: 1.05rem; font-weight: 800; margin-bottom: 16px; color: var(--primary); }
.field-label { font-size: .78rem; font-weight: 600; color: var(--muted); margin-bottom: 4px; margin-top: 12px; }
.field-row { display: flex; gap: 8px; }
input[type=text], input[type=date], input[type=time], select {
  background: #0f172a; border: 1.5px solid var(--border);
  border-radius: 10px; color: var(--text); padding: 10px 12px;
  font-size: .95rem; width: 100%; outline: none;
  font-family: inherit;
}
input[type=text]:focus, input[type=date]:focus, input[type=time]:focus, select:focus {
  border-color: var(--primary);
}
select { cursor: pointer; }
.modal-btns { display: flex; gap: 10px; margin-top: 20px; }
.btn-cancel {
  flex: 1; padding: 14px; background: #0f172a; border: 1.5px solid var(--border);
  border-radius: 12px; color: var(--muted); font-size: .95rem; font-weight: 600; cursor: pointer;
}
.btn-save {
  flex: 2; padding: 14px;
  background: linear-gradient(135deg, #0ea5e9, #38bdf8);
  border: none; border-radius: 12px; color: #0f172a;
  font-size: .95rem; font-weight: 800; cursor: pointer;
}

/* ‚îÄ‚îÄ Notify banner ‚îÄ‚îÄ */
.notify-banner {
  margin: 10px 12px 0;
  background: #1e3a2a; border: 1px solid #166534;
  border-radius: 10px; padding: 10px 14px;
  font-size: .82rem; color: #86efac;
  display: flex; align-items: center; justify-content: space-between; gap: 10px;
}
.notify-banner button {
  background: #166534; border: none; border-radius: 7px;
  color: #86efac; padding: 5px 10px; cursor: pointer; font-size: .8rem; white-space: nowrap;
}
.notify-banner.hidden { display: none; }

/* ‚îÄ‚îÄ Install banner ‚îÄ‚îÄ */
.install-banner {
  margin: 6px 12px 0;
  background: #1e293b; border: 1px solid #334155;
  border-radius: 10px; padding: 10px 14px;
  font-size: .82rem; color: var(--muted);
  display: flex; align-items: center; justify-content: space-between; gap: 10px;
}
.install-banner button {
  background: var(--border); border: none; border-radius: 7px;
  color: var(--text); padding: 5px 10px; cursor: pointer; font-size: .8rem; white-space: nowrap;
}
.install-banner.hidden { display: none; }
</style>
</head>
<body>

<header>
  <span class="app-title">üîî –ù–∞–ø–æ–º–Ω–∏</span>
  <div class="header-btns">
    <button class="icon-btn" onclick="showToday()">–°–µ–≥–æ–¥–Ω—è</button>
  </div>
</header>

<div class="notify-banner hidden" id="notifyBanner">
  <span>–†–∞–∑—Ä–µ—à–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è ‚Äî –∏–Ω–∞—á–µ –Ω–∞–ø–æ–º–∏–Ω–∞–ª–∫–∞ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç</span>
  <button onclick="askNotifyPermission()">–†–∞–∑—Ä–µ—à–∏—Ç—å</button>
</div>
<div class="install-banner hidden" id="installBanner">
  <span>–£—Å—Ç–∞–Ω–æ–≤–∏ –Ω–∞ —ç–∫—Ä–∞–Ω ‚Äî —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–∞–¥—ë–∂–Ω–µ–µ</span>
  <button id="installBtn">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
</div>

<!-- –ö–∞–ª–µ–Ω–¥–∞—Ä—å -->
<div class="cal-section">
  <div class="cal-nav">
    <button class="cal-arrow" onclick="shiftMonth(-1)">‚Äπ</button>
    <span class="cal-month" id="calMonthLabel"></span>
    <button class="cal-arrow" onclick="shiftMonth(1)">‚Ä∫</button>
  </div>
  <div class="cal-grid" id="calGrid"></div>
</div>

<!-- –ü–∞–Ω–µ–ª—å –¥–Ω—è -->
<div class="day-panel" id="dayPanel">
  <div class="day-panel-title" id="dayPanelTitle">–°–µ–≥–æ–¥–Ω—è</div>
  <div id="dayTaskList"><div class="empty-day">–ù–µ—Ç –∑–∞–¥–∞—á</div></div>
</div>

<!-- –ë–ª–∏–∂–∞–π—à–∏–µ (—Å–ª–µ–¥—É—é—â–∏–µ 7 –¥–Ω–µ–π, –∫—Ä–æ–º–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ) -->
<div class="upcoming-section" id="upcomingSection" style="display:none">
  <div class="section-title">–ë–ª–∏–∂–∞–π—à–∏–µ</div>
  <div id="upcomingList"></div>
</div>

<!-- FAB: –º–∏–∫—Ä–æ—Ñ–æ–Ω -->
<div class="fab-wrap">
  <div class="transcript-bubble" id="transcriptBubble"></div>
  <button class="mic-btn" id="micBtn" onclick="toggleMic()">üé§</button>
  <div class="mic-hint" id="micHint">–ì–æ–≤–æ—Ä–∏ –∑–∞–¥–∞—á—É</div>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞: –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏ -->
<div class="modal-backdrop" id="modalBackdrop">
  <div class="modal-sheet">
    <div class="modal-title">–ü—Ä–æ–≤–µ—Ä—å –∏ —Å–æ—Ö—Ä–∞–Ω–∏</div>

    <div class="field-label">–ó–∞–¥–∞—á–∞</div>
    <input type="text" id="fTask" placeholder="–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å">

    <div class="field-label">–ö–æ–≥–¥–∞ (–¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è)</div>
    <div class="field-row">
      <input type="date" id="fDate">
      <input type="time" id="fTime">
    </div>

    <div class="field-label">–ù–∞–ø–æ–º–Ω–∏—Ç—å</div>
    <div class="field-row">
      <select id="fReminderSel" onchange="onReminderSelChange()">
        <option value="">–°–≤–æ—ë –≤—Ä–µ–º—è ‚Üì</option>
        <option value="15">–ó–∞ 15 –º–∏–Ω—É—Ç</option>
        <option value="30">–ó–∞ 30 –º–∏–Ω—É—Ç</option>
        <option value="60">–ó–∞ 1 —á–∞—Å</option>
        <option value="120">–ó–∞ 2 —á–∞—Å–∞</option>
      </select>
      <input type="time" id="fReminderTime" oninput="onReminderTimeInput()">
    </div>

    <div class="modal-btns">
      <button class="btn-cancel" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn-save" onclick="saveTask()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å ‚úì</button>
    </div>
  </div>
</div>

<script>
'use strict';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// –•–†–ê–ù–ò–õ–ò–©–ï
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getTasks() {
  try { return JSON.parse(localStorage.getItem('napomni_tasks') || '[]'); }
  catch { return []; }
}
function saveTasks(tasks) {
  localStorage.setItem('napomni_tasks', JSON.stringify(tasks));
}
function addTask(task) {
  const tasks = getTasks();
  tasks.push(task);
  saveTasks(tasks);
}
function deleteTask(id) {
  saveTasks(getTasks().filter(t => t.id !== id));
  cancelNotification(id);
}
function markNotified(id) {
  const tasks = getTasks();
  const t = tasks.find(t => t.id === id);
  if (t) { t.notified = true; saveTasks(tasks); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function askNotifyPermission() {
  const r = await Notification.requestPermission();
  document.getElementById('notifyBanner').classList.add('hidden');
  if (r === 'granted') reschedulePending();
}

async function sendToSW(data) {
  if (!navigator.serviceWorker?.controller) return;
  navigator.serviceWorker.controller.postMessage(data);
}

async function scheduleNotification(task) {
  if (Notification.permission !== 'granted') return;
  const reminderTime = task.reminderTime || task.eventTime;
  if (!reminderTime || reminderTime <= Date.now()) return;
  await sendToSW({
    type: 'schedule',
    id: task.id,
    title: 'üîî –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ',
    body: `${task.text}  ‚Äî  –≤ ${formatHM(task.eventTime)}`,
    reminderTime,
  });
}

async function cancelNotification(id) {
  await sendToSW({ type: 'cancel', id });
}

async function reschedulePending() {
  const now = Date.now();
  for (const t of getTasks()) {
    if (!t.notified && (t.reminderTime || t.eventTime) > now) {
      await scheduleNotification(t);
    }
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// –§–û–†–ú–ê–¢ –î–ê–¢–ê/–í–†–ï–ú–Ø
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const RU_MONTHS = ['—è–Ω–≤–∞—Ä—å','—Ñ–µ–≤—Ä–∞–ª—å','–º–∞—Ä—Ç','–∞–ø—Ä–µ–ª—å','–º–∞–π','–∏—é–Ω—å',
                   '–∏—é–ª—å','–∞–≤–≥—É—Å—Ç','—Å–µ–Ω—Ç—è–±—Ä—å','–æ–∫—Ç—è–±—Ä—å','–Ω–æ—è–±—Ä—å','–¥–µ–∫–∞–±—Ä—å'];
const RU_MONTHS_GEN = ['—è–Ω–≤–∞—Ä—è','—Ñ–µ–≤—Ä–∞–ª—è','–º–∞—Ä—Ç–∞','–∞–ø—Ä–µ–ª—è','–º–∞—è','–∏—é–Ω—è',
                       '–∏—é–ª—è','–∞–≤–≥—É—Å—Ç–∞','—Å–µ–Ω—Ç—è–±—Ä—è','–æ–∫—Ç—è–±—Ä—è','–Ω–æ—è–±—Ä—è','–¥–µ–∫–∞–±—Ä—è'];
const RU_DOW = ['–≤—Å','–ø–Ω','–≤—Ç','—Å—Ä','—á—Ç','–ø—Ç','—Å–±'];

function formatHM(ts) {
  if (!ts) return '‚Äî';
  const d = new Date(ts);
  return d.getHours().toString().padStart(2,'0') + ':' + d.getMinutes().toString().padStart(2,'0');
}
function formatDateShort(ts) {
  const d = new Date(ts);
  const today = new Date(); today.setHours(0,0,0,0);
  const tomorrow = new Date(today); tomorrow.setDate(tomorrow.getDate()+1);
  const dt = new Date(ts); dt.setHours(0,0,0,0);
  if (dt.getTime() === today.getTime()) return '–°–µ–≥–æ–¥–Ω—è';
  if (dt.getTime() === tomorrow.getTime()) return '–ó–∞–≤—Ç—Ä–∞';
  return `${d.getDate()} ${RU_MONTHS_GEN[d.getMonth()]}`;
}
function ymd(ts) {
  const d = new Date(ts);
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}
function dateToYMD(date) { return ymd(date.getTime()); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// –ü–ê–†–°–ï–† –†–£–°–°–ö–û–ô –†–ï–ß–ò
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const RU_NUMS = {
  '–Ω–æ–ª—å':0,'–Ω—É–ª—å':0,
  '–æ–¥–∏–Ω':1,'–æ–¥–Ω—É':1,'–æ–¥–Ω–æ–≥–æ':1,'–æ–¥–Ω–∞':1,
  '–¥–≤–∞':2,'–¥–≤–µ':2,'–¥–≤—É—Ö':2,
  '—Ç—Ä–∏':3,'—Ç—Ä—ë—Ö':3,'—Ç—Ä–µ—Ö':3,
  '—á–µ—Ç—ã—Ä–µ':4,'—á–µ—Ç—ã—Ä—ë—Ö':4,'—á–µ—Ç—ã—Ä–µ—Ö':4,
  '–ø—è—Ç—å':5,'–ø—è—Ç–∏':5,
  '—à–µ—Å—Ç—å':6,'—à–µ—Å—Ç–∏':6,
  '—Å–µ–º—å':7,'—Å–µ–º–∏':7,
  '–≤–æ—Å–µ–º—å':8,'–≤–æ—Å—å–º–∏':8,
  '–¥–µ–≤—è—Ç—å':9,'–¥–µ–≤—è—Ç–∏':9,
  '–¥–µ—Å—è—Ç—å':10,'–¥–µ—Å—è—Ç–∏':10,
  '–æ–¥–∏–Ω–Ω–∞–¥—Ü–∞—Ç—å':11,'–æ–¥–∏–Ω–Ω–∞–¥—Ü–∞—Ç–∏':11,
  '–¥–≤–µ–Ω–∞–¥—Ü–∞—Ç—å':12,'–¥–≤–µ–Ω–∞–¥—Ü–∞—Ç–∏':12,
  '—Ç—Ä–∏–Ω–∞–¥—Ü–∞—Ç—å':13,'—á–µ—Ç—ã—Ä–Ω–∞–¥—Ü–∞—Ç—å':14,
  '–ø—è—Ç–Ω–∞–¥—Ü–∞—Ç—å':15,'—à–µ—Å—Ç–Ω–∞–¥—Ü–∞—Ç—å':16,
  '—Å–µ–º–Ω–∞–¥—Ü–∞—Ç—å':17,'–≤–æ—Å–µ–º–Ω–∞–¥—Ü–∞—Ç—å':18,
  '–¥–µ–≤—è—Ç–Ω–∞–¥—Ü–∞—Ç—å':19,'–¥–≤–∞–¥—Ü–∞—Ç—å':20,
  '—Ç—Ä–∏–¥—Ü–∞—Ç—å':30,'—Å–æ—Ä–æ–∫':40,'–ø—è—Ç—å–¥–µ—Å—è—Ç':50,
};
function parseRuNum(w) {
  if (/^\d+$/.test(w)) return parseInt(w);
  return RU_NUMS[w] ?? null;
}
function parseRuNumPhrase(phrase) {
  const words = phrase.trim().split(/\s+/);
  let total = 0, found = false;
  for (const w of words) {
    const n = parseRuNum(w);
    if (n === null) return null;
    total += n; found = true;
  }
  return found ? total : null;
}

const RU_WEEKDAYS = {
  '–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫':1,'–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫–∞':1,
  '–≤—Ç–æ—Ä–Ω–∏–∫':2,'–≤—Ç–æ—Ä–Ω–∏–∫–∞':2,
  '—Å—Ä–µ–¥–∞':3,'—Å—Ä–µ–¥—É':3,'—Å—Ä–µ–¥—ã':3,
  '—á–µ—Ç–≤–µ—Ä–≥':4,'—á–µ—Ç–≤–µ—Ä–≥–∞':4,
  '–ø—è—Ç–Ω–∏—Ü–∞':5,'–ø—è—Ç–Ω–∏—Ü—É':5,'–ø—è—Ç–Ω–∏—Ü—ã':5,
  '—Å—É–±–±–æ—Ç–∞':6,'—Å—É–±–±–æ—Ç—É':6,'—Å—É–±–±–æ—Ç—ã':6,
  '–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ':0,'–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å—è':0,
};

function nextWeekday(dow) {
  const today = new Date(); today.setHours(0,0,0,0);
  const d = new Date(today);
  const diff = (dow - d.getDay() + 7) % 7 || 7;
  d.setDate(d.getDate() + diff);
  return d;
}

// –ü–∞—Ä—Å–∏–º —á–∞—Å –∏ –º–∏–Ω—É—Ç—ã –∏–∑ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞ –≤—Ä–æ–¥–µ "—Ç—Ä–∏", "15", "—Ç—Ä–∏ —Ç—Ä–∏–¥—Ü–∞—Ç—å", "15:30"
function parseTimeFragment(frag, period) {
  frag = frag.trim();
  // –¶–∏—Ñ—Ä–æ–≤–æ–π —Ñ–æ—Ä–º–∞—Ç "HH:MM" –∏–ª–∏ "HH"
  const digitColon = frag.match(/^(\d{1,2})(?::(\d{2}))?$/);
  if (digitColon) {
    let h = parseInt(digitColon[1]);
    const m = digitColon[2] ? parseInt(digitColon[2]) : 0;
    h = applyPeriod(h, period);
    return { h, m };
  }
  // –°–ª–æ–≤–µ—Å–Ω—ã–π: "—Ç—Ä–∏", "—Ç—Ä–∏ —Ç—Ä–∏–¥—Ü–∞—Ç—å", "–ø—è—Ç–Ω–∞–¥—Ü–∞—Ç—å"
  const words = frag.split(/\s+/);
  const h0 = parseRuNum(words[0]);
  if (h0 === null) return null;
  let m = 0;
  if (words.length >= 2) {
    const m0 = parseRuNum(words[1]);
    if (m0 !== null) m = m0;
  }
  return { h: applyPeriod(h0, period), m };
}

function applyPeriod(h, period) {
  if (!period) {
    // –≠–≤—Ä–∏—Å—Ç–∏–∫–∞: 1-7 ‚Üí PM (13-19), –æ—Å—Ç–∞–ª—å–Ω—ã–µ –æ—Å—Ç–∞–≤–ª—è–µ–º
    if (h >= 1 && h <= 7) return h + 12;
    return h;
  }
  if (/—É—Ç—Ä–∞|—É—Ç—Ä–æ–º/.test(period)) return h; // AM
  if (/–¥–Ω—è|–¥–Ω—ë–º|–¥–Ω–µ–º|–ø–æ–ª–¥–Ω—è/.test(period)) return h < 12 ? h + 12 : h;
  if (/–≤–µ—á–µ—Ä–∞|–≤–µ—á–µ—Ä–æ–º/.test(period)) return h < 12 ? h + 12 : h;
  if (/–Ω–æ—á–∏|–Ω–æ—á—å—é/.test(period)) return h < 6 ? h : h; // –æ—Å—Ç–∞–≤–ª—è–µ–º
  return h;
}

function parseVoiceInput(raw) {
  let text = raw.toLowerCase().trim();

  // –®–∞–≥ 1: —Ä–∞–∑–¥–µ–ª–∏—Ç—å –Ω–∞ —á–∞—Å—Ç—å –∑–∞–¥–∞—á–∏+—Å–æ–±—ã—Ç–∏—è –∏ —á–∞—Å—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
  let eventPart = text, reminderPart = '';
  const reminderKw = /\s*–Ω–∞–ø–æ–º–Ω[–∞-—è—ë]+\s*/;
  const rm = text.match(reminderKw);
  if (rm) {
    eventPart = text.slice(0, rm.index).trim();
    reminderPart = text.slice(rm.index + rm[0].length).trim();
  }

  // –®–∞–≥ 2: –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –¥–µ–Ω—å
  let day = null;
  const today = new Date(); today.setHours(0,0,0,0);

  if (/\b—Å–µ–≥–æ–¥–Ω—è\b/.test(eventPart)) {
    day = new Date(today);
    eventPart = eventPart.replace(/\b—Å–µ–≥–æ–¥–Ω—è\b/, '').trim();
  } else if (/\b–∑–∞–≤—Ç—Ä–∞\b/.test(eventPart)) {
    day = new Date(today); day.setDate(day.getDate()+1);
    eventPart = eventPart.replace(/\b–∑–∞–≤—Ç—Ä–∞\b/, '').trim();
  } else if (/\b–ø–æ—Å–ª–µ–∑–∞–≤—Ç—Ä–∞\b/.test(eventPart)) {
    day = new Date(today); day.setDate(day.getDate()+2);
    eventPart = eventPart.replace(/\b–ø–æ—Å–ª–µ–∑–∞–≤—Ç—Ä–∞\b/, '').trim();
  } else {
    // –î–µ–Ω—å –Ω–µ–¥–µ–ª–∏: "–≤ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫", "–≤ –ø—è—Ç–Ω–∏—Ü—É", "–≤–æ –≤—Ç–æ—Ä–Ω–∏–∫"
    const wdMatch = eventPart.match(/\b–≤–æ?\s+([–∞-—è—ë]+(?:—É|—é|–µ|–∏)?)\b/);
    if (wdMatch) {
      const wd = RU_WEEKDAYS[wdMatch[1]];
      if (wd !== undefined) {
        day = nextWeekday(wd);
        eventPart = eventPart.replace(wdMatch[0], '').trim();
      }
    }
    if (!day) { day = new Date(today); } // default: —Å–µ–≥–æ–¥–Ω—è
  }

  // –®–∞–≥ 3: –∏–∑–≤–ª–µ—á—å –≤—Ä–µ–º—è —Å–æ–±—ã—Ç–∏—è
  // –ò—â–µ–º "–≤ [–≤—Ä–µ–º—è] [—É—Ç—Ä–∞/–¥–Ω—è/–≤–µ—á–µ—Ä–∞]?" ‚Äî –ø–µ—Ä–µ–±–∏—Ä–∞–µ–º –≤—Å–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è, –±–µ—Ä—ë–º –ø–µ—Ä–≤–æ–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω–æ–µ
  let eventH = null, eventM = 0;
  const timePattern = /\b–≤\s+((?:\d{1,2}(?::\d{2})?)|(?:[–∞-—è—ë]+(?:\s+[–∞-—è—ë]+)?))\s*(—É—Ç—Ä–∞|—É—Ç—Ä–æ–º|–¥–Ω—è|–¥–Ω—ë–º|–¥–Ω–µ–º|–≤–µ—á–µ—Ä–∞|–≤–µ—á–µ—Ä–æ–º|–Ω–æ—á–∏|–Ω–æ—á—å—é)?/g;
  let tm;
  while ((tm = timePattern.exec(eventPart)) !== null) {
    const parsed = parseTimeFragment(tm[1], tm[2]);
    if (parsed) {
      eventH = parsed.h; eventM = parsed.m;
      eventPart = (eventPart.slice(0, tm.index) + ' ' + eventPart.slice(tm.index + tm[0].length)).trim();
      break;
    }
  }

  // –®–∞–≥ 4: –æ—Å—Ç–∞—Ç–æ–∫ ‚Äî –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏
  const taskName = eventPart.replace(/\s+/g, ' ').trim() || '–ó–∞–¥–∞—á–∞';

  // –®–∞–≥ 5: –≤—Ä–µ–º—è —Å–æ–±—ã—Ç–∏—è
  let eventTime = null;
  if (eventH !== null) {
    eventTime = new Date(day);
    eventTime.setHours(eventH, eventM, 0, 0);
  }

  // –®–∞–≥ 6: –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ
  let reminderTime = null;
  if (reminderPart && eventTime) {
    reminderTime = parseReminderPart(reminderPart, eventTime);
  }

  return { taskName, eventTime, reminderTime };
}

function parseReminderPart(spec, eventTime) {
  spec = spec.trim();

  // "–∑–∞ –ø–æ–ª—á–∞—Å–∞"
  if (/–ø–æ–ª—á–∞—Å–∞|–ø–æ–ª—Ç–æ—Ä–∞\s+—á–∞—Å–∞/.test(spec)) {
    const mins = /–ø–æ–ª—Ç–æ—Ä–∞/.test(spec) ? 90 : 30;
    return new Date(eventTime.getTime() - mins * 60000);
  }

  // "–∑–∞ —á–∞—Å"
  if (/^–∑–∞\s+—á–∞—Å$/.test(spec)) {
    return new Date(eventTime.getTime() - 60 * 60000);
  }

  // "–∑–∞ N –º–∏–Ω—É—Ç"
  const minMatch = spec.match(/–∑–∞\s+(?:(\d+)|([–∞-—è—ë]+(?:\s+[–∞-—è—ë]+)?))\s+–º–∏–Ω—É—Ç/);
  if (minMatch) {
    const n = minMatch[1] ? parseInt(minMatch[1]) : parseRuNumPhrase(minMatch[2]);
    if (n) return new Date(eventTime.getTime() - n * 60000);
  }

  // "–∑–∞ N —á–∞—Å–∞/—á–∞—Å–æ–≤"
  const hrMatch = spec.match(/–∑–∞\s+(?:(\d+)|([–∞-—è—ë]+(?:\s+[–∞-—è—ë]+)?))\s+—á–∞—Å/);
  if (hrMatch) {
    const n = hrMatch[1] ? parseInt(hrMatch[1]) : parseRuNumPhrase(hrMatch[2]);
    if (n) return new Date(eventTime.getTime() - n * 3600000);
  }

  // "–≤ [–≤—Ä–µ–º—è]" ‚Äî –∞–±—Å–æ–ª—é—Ç–Ω–æ–µ
  const atMatch = spec.match(/(?:^|–≤\s+)((?:\d{1,2}(?::\d{2})?)|(?:[–∞-—è—ë]+(?:\s+[–∞-—è—ë]+)?))\s*(—É—Ç—Ä–∞|—É—Ç—Ä–æ–º|–¥–Ω—è|–¥–Ω—ë–º|–¥–Ω–µ–º|–≤–µ—á–µ—Ä–∞|–≤–µ—á–µ—Ä–æ–º)?/);
  if (atMatch) {
    const parsed = parseTimeFragment(atMatch[1], atMatch[2]);
    if (parsed) {
      const d = new Date(eventTime);
      d.setHours(parsed.h, parsed.m, 0, 0);
      return d;
    }
  }

  return null;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// –†–ê–°–ü–û–ó–ù–ê–í–ê–ù–ò–ï –ì–û–õ–û–°–ê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let recognition = null;
let isListening = false;

function toggleMic() {
  if (isListening) { stopMic(); }
  else { startMic(); }
}

function startMic() {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) {
    alert('–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è. –ò—Å–ø–æ–ª—å–∑—É–π Chrome –Ω–∞ Android.');
    return;
  }
  recognition = new SR();
  recognition.lang = 'ru-RU';
  recognition.continuous = false;
  recognition.interimResults = true;

  recognition.onstart = () => {
    isListening = true;
    document.getElementById('micBtn').classList.add('listening');
    document.getElementById('micHint').textContent = '–°–ª—É—à–∞—é...';
    const tb = document.getElementById('transcriptBubble');
    tb.textContent = '‚Ä¶'; tb.classList.add('show');
  };

  recognition.onresult = e => {
    let interim = '', final = '';
    for (const r of e.results) {
      if (r.isFinal) final += r[0].transcript;
      else interim += r[0].transcript;
    }
    document.getElementById('transcriptBubble').textContent = final || interim;
    if (final) { stopMic(); openPreview(final.trim()); }
  };

  recognition.onerror = e => {
    stopMic();
    if (e.error !== 'no-speech') alert('–û—à–∏–±–∫–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞: ' + e.error);
  };

  recognition.onend = () => stopMic();
  recognition.start();
}

function stopMic() {
  isListening = false;
  if (recognition) { try { recognition.stop(); } catch {} recognition = null; }
  document.getElementById('micBtn').classList.remove('listening');
  document.getElementById('micHint').textContent = '–ì–æ–≤–æ—Ä–∏ –∑–∞–¥–∞—á—É';
  document.getElementById('transcriptBubble').classList.remove('show');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// –ú–û–î–ê–õ–ö–ê –ü–†–ï–î–ü–†–û–°–ú–û–¢–†–ê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openPreview(transcript) {
  const { taskName, eventTime, reminderTime } = parseVoiceInput(transcript);

  document.getElementById('fTask').value = taskName;

  const now = new Date();
  const eDate = eventTime || now;
  document.getElementById('fDate').value = dateToYMD(eDate);
  document.getElementById('fTime').value =
    eventTime ? `${String(eventTime.getHours()).padStart(2,'0')}:${String(eventTime.getMinutes()).padStart(2,'0')}` : '';

  if (reminderTime) {
    document.getElementById('fReminderTime').value =
      `${String(reminderTime.getHours()).padStart(2,'0')}:${String(reminderTime.getMinutes()).padStart(2,'0')}`;
    document.getElementById('fReminderSel').value = '';
  } else {
    document.getElementById('fReminderTime').value = '';
    document.getElementById('fReminderSel').value = '30';
    onReminderSelChange();
  }

  document.getElementById('modalBackdrop').classList.add('show');
}

function closeModal() {
  document.getElementById('modalBackdrop').classList.remove('show');
}

function onReminderSelChange() {
  const mins = parseInt(document.getElementById('fReminderSel').value);
  if (!mins) return;
  const dateVal = document.getElementById('fDate').value;
  const timeVal = document.getElementById('fTime').value;
  if (!dateVal || !timeVal) return;
  const eventDT = new Date(`${dateVal}T${timeVal}:00`);
  const rem = new Date(eventDT.getTime() - mins * 60000);
  document.getElementById('fReminderTime').value =
    `${String(rem.getHours()).padStart(2,'0')}:${String(rem.getMinutes()).padStart(2,'0')}`;
}

function onReminderTimeInput() {
  document.getElementById('fReminderSel').value = '';
}

function saveTask() {
  const text = document.getElementById('fTask').value.trim();
  const dateVal = document.getElementById('fDate').value;
  const timeVal = document.getElementById('fTime').value;
  const reminderVal = document.getElementById('fReminderTime').value;

  if (!text) { alert('–í–≤–µ–¥–∏ –∑–∞–¥–∞—á—É'); return; }
  if (!dateVal) { alert('–£–∫–∞–∂–∏ –¥–∞—Ç—É'); return; }
  if (!timeVal) { alert('–£–∫–∞–∂–∏ –≤—Ä–µ–º—è'); return; }
  if (!reminderVal) { alert('–£–∫–∞–∂–∏ –≤—Ä–µ–º—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è'); return; }

  const eventTime = new Date(`${dateVal}T${timeVal}:00`).getTime();
  const reminderTime = new Date(`${dateVal}T${reminderVal}:00`).getTime();

  const task = {
    id: Date.now(),
    text,
    eventTime,
    reminderTime,
    notified: false,
  };

  addTask(task);
  scheduleNotification(task);
  closeModal();
  renderAll();

  // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –¥–µ–Ω—å –∑–∞–¥–∞—á–∏
  selectedYMD = ymd(eventTime);
  renderCalendar();
  renderDayPanel();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// –¶–í–ï–¢–ê –ó–ê–î–ê–ß
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const TASK_COLORS = ['#38bdf8','#f472b6','#34d399','#fbbf24','#a78bfa','#fb923c'];
function taskColor(id) { return TASK_COLORS[id % TASK_COLORS.length]; }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// –ö–ê–õ–ï–ù–î–ê–†–¨
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let viewYear, viewMonth, selectedYMD;

function initCalendar() {
  const now = new Date();
  viewYear = now.getFullYear();
  viewMonth = now.getMonth();
  selectedYMD = dateToYMD(now);
}

function shiftMonth(delta) {
  viewMonth += delta;
  if (viewMonth > 11) { viewMonth = 0; viewYear++; }
  if (viewMonth < 0)  { viewMonth = 11; viewYear--; }
  renderCalendar();
}

function showToday() {
  const now = new Date();
  viewYear = now.getFullYear();
  viewMonth = now.getMonth();
  selectedYMD = dateToYMD(now);
  renderCalendar();
  renderDayPanel();
}

function renderCalendar() {
  const label = RU_MONTHS[viewMonth] + ' ' + viewYear;
  document.getElementById('calMonthLabel').textContent =
    label.charAt(0).toUpperCase() + label.slice(1);

  const grid = document.getElementById('calGrid');
  grid.innerHTML = '';

  // –ó–∞–≥–æ–ª–æ–≤–∫–∏ –¥–Ω–µ–π –Ω–µ–¥–µ–ª–∏ (–ø–Ω-–≤—Å)
  const dows = ['–ø–Ω','–≤—Ç','—Å—Ä','—á—Ç','–ø—Ç','—Å–±','–≤—Å'];
  for (const d of dows) {
    const el = document.createElement('div');
    el.className = 'cal-dow'; el.textContent = d;
    grid.appendChild(el);
  }

  // –°–æ–±–∏—Ä–∞–µ–º –∑–∞–¥–∞—á–∏ –ø–æ –¥–Ω—è–º
  const tasks = getTasks();
  const tasksByDay = {};
  for (const t of tasks) {
    const k = ymd(t.eventTime);
    if (!tasksByDay[k]) tasksByDay[k] = [];
    tasksByDay[k].push(t);
  }

  const todayYMD = dateToYMD(new Date());
  const firstDay = new Date(viewYear, viewMonth, 1);
  // –°–º–µ—â–µ–Ω–∏–µ: –ø–Ω=0
  let startDow = (firstDay.getDay() + 6) % 7;
  const daysInMonth = new Date(viewYear, viewMonth+1, 0).getDate();
  const daysInPrev  = new Date(viewYear, viewMonth, 0).getDate();

  const total = Math.ceil((startDow + daysInMonth) / 7) * 7;

  for (let i = 0; i < total; i++) {
    let d, isOther = false;
    if (i < startDow) {
      d = new Date(viewYear, viewMonth-1, daysInPrev - startDow + i + 1);
      isOther = true;
    } else if (i >= startDow + daysInMonth) {
      d = new Date(viewYear, viewMonth+1, i - startDow - daysInMonth + 1);
      isOther = true;
    } else {
      d = new Date(viewYear, viewMonth, i - startDow + 1);
    }

    const key = dateToYMD(d);
    const el = document.createElement('div');
    el.className = 'cal-day' +
      (isOther ? ' other-month' : '') +
      (key === todayYMD ? ' today' : '') +
      (key === selectedYMD ? ' selected' : '');

    const numEl = document.createElement('div');
    numEl.className = 'day-num';
    numEl.textContent = d.getDate();
    el.appendChild(numEl);

    if (tasksByDay[key]?.length) {
      const dots = document.createElement('div');
      dots.className = 'day-dots';
      for (const t of tasksByDay[key].slice(0,3)) {
        const dot = document.createElement('div');
        dot.className = 'day-dot';
        dot.style.background = taskColor(t.id);
        dots.appendChild(dot);
      }
      el.appendChild(dots);
    }

    el.addEventListener('click', () => {
      selectedYMD = key;
      renderCalendar();
      renderDayPanel();
    });

    grid.appendChild(el);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// –ü–ê–ù–ï–õ–¨ –î–ù–Ø
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderDayPanel() {
  const tasks = getTasks().filter(t => ymd(t.eventTime) === selectedYMD);
  tasks.sort((a,b) => a.eventTime - b.eventTime);

  const todayYMD = dateToYMD(new Date());
  const selDate = new Date(selectedYMD + 'T00:00:00');
  let title = selectedYMD === todayYMD ? '–°–µ–≥–æ–¥–Ω—è' :
    `${selDate.getDate()} ${RU_MONTHS_GEN[selDate.getMonth()]}`;
  document.getElementById('dayPanelTitle').textContent = title;

  const list = document.getElementById('dayTaskList');
  list.innerHTML = '';

  if (!tasks.length) {
    list.innerHTML = '<div class="empty-day">–ù–µ—Ç –∑–∞–¥–∞—á</div>';
    return;
  }

  const now = Date.now();
  for (const t of tasks) {
    const past = t.eventTime < now;
    const el = document.createElement('div');
    el.className = 'task-item' + (past ? ' past' : '');

    const dot = document.createElement('div');
    dot.className = 'task-dot';
    dot.style.background = taskColor(t.id);

    const info = document.createElement('div');
    info.className = 'task-info';

    const txt = document.createElement('div');
    txt.className = 'task-text';
    txt.textContent = t.text;

    const times = document.createElement('div');
    times.className = 'task-times';
    times.textContent = `–≤ ${formatHM(t.eventTime)}  ¬∑  –Ω–∞–ø–æ–º–Ω—é –≤ ${formatHM(t.reminderTime)}`;

    info.appendChild(txt);
    info.appendChild(times);

    const del = document.createElement('button');
    del.className = 'task-del';
    del.textContent = '√ó';
    del.addEventListener('click', () => {
      if (confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É?')) { deleteTask(t.id); renderAll(); }
    });

    el.appendChild(dot); el.appendChild(info); el.appendChild(del);
    list.appendChild(el);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// –†–ï–ù–î–ï–†
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderAll() {
  renderCalendar();
  renderDayPanel();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INSTALL PROMPT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let deferredInstall = null;
window.addEventListener('beforeinstallprompt', e => {
  e.preventDefault(); deferredInstall = e;
  document.getElementById('installBanner').classList.remove('hidden');
});
document.getElementById('installBtn')?.addEventListener('click', async () => {
  if (!deferredInstall) return;
  deferredInstall.prompt();
  const { outcome } = await deferredInstall.userChoice;
  if (outcome === 'accepted') {
    document.getElementById('installBanner').classList.add('hidden');
  }
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// –°–¢–ê–†–¢
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
(async function init() {
  // Service Worker
  if ('serviceWorker' in navigator) {
    try {
      await navigator.serviceWorker.register('./sw.js');
    } catch (e) { console.warn('SW:', e); }
  }

  // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
  if ('Notification' in window && Notification.permission === 'default') {
    document.getElementById('notifyBanner').classList.remove('hidden');
  } else if (Notification.permission === 'granted') {
    await reschedulePending();
  }

  // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Ñ–æ–Ω
  document.getElementById('modalBackdrop').addEventListener('click', e => {
    if (e.target === document.getElementById('modalBackdrop')) closeModal();
  });

  initCalendar();
  renderAll();
})();
</script>
</body>
</html>
